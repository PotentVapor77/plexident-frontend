# ============================================================
# nginx.conf — plexident.org
# Frontend React (dentro del contenedor Docker)
# SSL termination: Certbot en el host → este contenedor en HTTP
#
# ARQUITECTURA:
#   Internet → nginx HOST (puerto 443 SSL, Certbot) 
#            → contenedor frontend (puerto 80 interno)
#            → contenedor backend (puerto 8000 interno)
# ============================================================

server {
    listen 80;
    server_name _;   # Acepta cualquier host (el SSL ya lo maneja el nginx del host)

    # ── Frontend React ──────────────────────────────────────
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # ── Proxy → Django Backend ──────────────────────────────
    location /api/ {
        proxy_pass              http://backend:8000/api/;
        proxy_set_header        Host                $host;
        proxy_set_header        X-Real-IP           $remote_addr;
        proxy_set_header        X-Forwarded-For     $proxy_add_x_forwarded_for;
        # CRÍTICO: le dice a Django que la petición original llegó por HTTPS.
        # Necesario para que SECURE_PROXY_SSL_HEADER funcione y las cookies
        # JWT se emitan con Secure=True y SameSite=None correctamente.
        proxy_set_header        X-Forwarded-Proto   https;

        # Soporte para cookies (withCredentials en axios)
        proxy_pass_header       Set-Cookie;

        proxy_connect_timeout   90s;
        proxy_send_timeout      90s;
        proxy_read_timeout      90s;

        # Buffer razonable para respuestas Django
        proxy_buffer_size       16k;
        proxy_buffers           4 32k;
        proxy_busy_buffers_size 64k;
    }

    # ── Django Admin ─────────────────────────────────────────
    location /admin/ {
        proxy_pass              http://backend:8000/admin/;
        proxy_set_header        Host                $host;
        proxy_set_header        X-Real-IP           $remote_addr;
        proxy_set_header        X-Forwarded-For     $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto   https;
        proxy_pass_header       Set-Cookie;
        proxy_read_timeout      90s;
    }

    # ── Django Static Files ──────────────────────────────────
    location /static/ {
        proxy_pass              http://backend:8000/static/;
        proxy_set_header        Host                $host;
        proxy_set_header        X-Forwarded-Proto   https;
    }

    # ── Error pages ──────────────────────────────────────────
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}